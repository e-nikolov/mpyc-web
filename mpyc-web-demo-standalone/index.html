<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
  <script src="/coi-serviceworker.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MPyC Web - Basic</title>
  <link async rel="icon" href="/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" rel="stylesheet" />

  <script type="module">
    import { MPCManager, PeerJSTransport, PyScriptWorkerRuntime } from "https://cdn.jsdelivr.net/npm/@mpyc-web/core@0.8.0/+esm";
    import { EditorState } from "https://cdn.jsdelivr.net/npm/@codemirror/state@6.3.3/+esm";
    import { python } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-python@6.1.3/+esm";
    import { EditorView, basicSetup } from "https://cdn.jsdelivr.net/npm/codemirror@6.0.1/+esm";
    import { Terminal } from "https://cdn.jsdelivr.net/npm/xterm@5.3.0/+esm";

    let mpyc = new MPCManager(
      () => new PeerJSTransport(),
      () => new PyScriptWorkerRuntime(undefined, "./config.toml")
    );

    let term = new Terminal();
    let editor = new EditorView({
      doc: `from mpyc.runtime import mpc
import secretsanta
async def main():
  await secretsanta.main()
mpc.run(main())`,
      extensions: [basicSetup, python()],
      parent: document.querySelector("#editor"),
    });
    term.open(document.querySelector("#terminal"));

    mpyc.on("transport:ready", async (peerID) => {
      console.log("Peer ID: " + peerID);
      document.querySelector("#myPeerID").value = peerID;
    });
    mpyc.on("runtime:display", async (message) => {
      term.writeln(message);
    });
    mpyc.on("runtime:display:error", async (message) => {
      console.error(message);
      term.writeln(message);
    });

    mpyc.on("transport:conn:ready", async (peerID) => {
      term.writeln("Connected to " + peerID);
    });
    mpyc.on("transport:conn:disconnected", async (peerID) => {
      term.writeln("Disconnected from" + peerID);
    });
    document.querySelector("#connect").addEventListener("click", () => {
      mpyc.transport.connect(document.querySelector("#hostPeerID").value);
    });
    document.querySelector("#startButton").addEventListener("click", () => {
      mpyc.runMPC(editor.state.doc.toString(), "test.py", false);
    });
  </script>
</head>

<body>
  <h3>MPyC Web - Basic</h3>
  <input id="myPeerID" type="text" onClick="this.select();" readonly placeholder="My ID" />
  <input id="hostPeerID" type="text" onClick="this.select();" placeholder="Party ID" />
  <button id="connect">Connect</button>
  <button id="startButton">Run</button>
  <div id="editor" class="editor"></div>
  <div id="terminal" class="terminal-wrapper term"></div>
</body>

</html>
